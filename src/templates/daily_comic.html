{% extends "base.html" %}

{% block title %}Generate Daily Comic{% endblock %}

{% block header %}Generate Daily Comic{% endblock %}

{% block content %}
    <div id="comic-generation-form">
        <div id="map-config" data-default-lat="{{ config.DEFAULT_LAT }}" data-default-lon="{{ config.DEFAULT_LON }}" style="display: none;"></div>
        <form id="daily-comic-form" method="POST">
            <div class="top-container">
                <div class="left-column">
                    <div id="map-search">
                        <input type="text" id="search-input" placeholder="Search for a location">
                        <button type="button" id="search-button">Search</button>
                    </div>
                    <div id="additional-inputs" style="display: none;">
                        <div id="artist-style-checkbox">
                            <input type="checkbox" id="use-artist-style" name="use_artist_style">
                            <label for="use-artist-style">Specify Comic Artist Style</label>
                        </div>
                        <div id="artist-style-input" style="display: none;">
                            <label for="comic-artist-style">Comic Artist Style:</label>
                            <input type="text" id="comic-artist-style" name="comic_artist_style" placeholder="e.g., Herbert Block">
                        </div>
                        <button type="submit" id="generate-button" class="btn">Generate Daily Comic</button>
                    </div>
                </div>
                <div class="right-column">
                    <div id="map"></div>
                    <div id="location-display" style="display: none;">
                        <p>Location found: <span id="found-location"></span></p>
                    </div>
                </div>
            </div>
            <input type="hidden" id="selected-location" name="location">
        </form>
    </div>

    <div id="result"></div>

    {% if request.path != url_for('index') %}
        <a href="{{ url_for('index') }}" class="back-arrow"><i class="fas fa-arrow-left"></i> Back to Home</a>
    {% endif %}
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .top-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    .left-column, .right-column {
        width: 48%;
    }
    #map-search {
        margin-bottom: 10px;
    }
    #search-input {
        width: 70%;
        padding: 5px;
    }
    #search-button {
        padding: 5px 10px;
    }
    #map {
        height: 300px;
        width: 100%;
        margin-bottom: 10px;
        border: 1px solid #8b4513;
    }
    #additional-inputs {
        margin-top: 20px;
    }
    #artist-style-input {
        margin-top: 10px;
    }
    #comic-artist-style {
        width: 100%;
        padding: 5px;
    }
    .back-arrow {
        display: inline-block;
        margin-top: 20px;
        text-decoration: none;
        color: #007bff;
    }
    .back-arrow:hover {
        text-decoration: underline;
    }
    .error {
        color: #dc3545;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Daily comic script loaded');

    var mapConfig = document.getElementById('map-config');
    var defaultLat = parseFloat(mapConfig.dataset.defaultLat) || 50.693802;
    var defaultLon = parseFloat(mapConfig.dataset.defaultLon) || -121.936584;

    console.log('Using coordinates:', defaultLat, defaultLon);

    var map = L.map('map').setView([defaultLat, defaultLon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    window.map = map;  // Make map globally accessible

    var marker;

    function setMarker(latlng) {
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker(latlng).addTo(map);
    }

    document.getElementById('search-button').addEventListener('click', function() {
        var searchQuery = document.getElementById('search-input').value;
        fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(searchQuery))
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    var latlng = L.latLng(parseFloat(data[0].lat), parseFloat(data[0].lon));
                    map.setView(latlng, 13);
                    setMarker(latlng);

                    var foundLocation = data[0].display_name;
                    
                    document.getElementById('found-location').textContent = foundLocation;
                    document.getElementById('location-display').style.display = 'block';
                    
                    document.getElementById('selected-location').value = foundLocation;
                    document.getElementById('additional-inputs').style.display = 'block';
                } else {
                    alert('Location not found');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while searching for the location');
            });
    });

    document.getElementById('use-artist-style').addEventListener('change', function() {
        document.getElementById('artist-style-input').style.display = this.checked ? 'block' : 'none';
        document.getElementById('comic-artist-style').required = this.checked;
    });

    // Initialize the progress bar
    initializeProgressBar('daily-comic-form', '/daily_comic_progress');
});
</script>
{% endblock %}
